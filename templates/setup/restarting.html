{% extends "base.html" %}

{% block title %}Applying Cloud Run updates{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h1 class="h4 mb-3">Applying Cloud Run updates</h1>
          <p class="text-muted">
            We saved the infrastructure settings and requested a Cloud Run
            service update. This can take a minute. We'll automatically check
            every few seconds and return you to setup once the service is
            healthy.
          </p>
          <p class="mb-0">
            You can leave this page open while the update completes.
          </p>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (() => {
      const healthUrl = "{{ health_url }}";
      const setupUrl = "{{ setup_url }}";
      const pollIntervalMs = 5000;
      let pollTimeoutId = null;
      let isRedirecting = false;

      const probeUrl = async (url) => {
        const response = await fetch(url, {
          cache: "no-store",
          credentials: "same-origin",
        });
        return response.ok;
      };

      const handleHealthy = () => {
        if (isRedirecting) {
          return;
        }
        isRedirecting = true;
        if (pollTimeoutId) {
          window.clearTimeout(pollTimeoutId);
        }
        window.location.assign(setupUrl);
      };

      const scheduleNextCheck = () => {
        pollTimeoutId = window.setTimeout(checkHealth, pollIntervalMs);
      };

      const checkHealth = async () => {
        try {
          if (await probeUrl(healthUrl)) {
            handleHealthy();
            return;
          }
          if (await probeUrl(setupUrl)) {
            handleHealthy();
            return;
          }
        } catch (error) {
          // Swallow network errors while the service restarts.
        }
        scheduleNextCheck();
      };

      checkHealth();
    })();
  </script>
{% endblock %}
