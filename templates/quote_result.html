{% extends 'base.html' %}
{% block content %}
<h1 class="fsi-display mb-2">Quote Result</h1>
<p class="fsi-body">Origin: {{ quote.origin }} | Destination: {{ quote.destination }}</p>

{% if origin_notes or dest_notes %}
<div class="fsi-notice fsi-notice--warning shadow-sm mb-4" role="alert">
  {% if origin_notes %}
  <p class="mb-2"><strong>Shipment Note for {{ quote.origin }}:</strong> {{ origin_notes }}</p>
  {% endif %}
  {% if dest_notes %}
  <p class="mb-0"><strong>Shipment Note for {{ quote.destination }}:</strong> {{ dest_notes }}</p>
  {% endif %}
</div>
{% endif %}

<p class="fsi-body">Type: {{ quote.quote_type }} | Weight: {{ '%.2f'|format(quote.weight) }} lbs ({{ quote.weight_method }})</p>
<p class="fsi-body"><strong>Rate set used:</strong> {{ quote.rate_set }}</p>
<p class="fsi-body"><strong>Request IP:</strong> {{ quote.request_ip or "N/A" }}</p>

{% set base_total = quote.total - metadata.accessorial_total %}
{% set grand_total = base_total + metadata.accessorial_total %}

<div class="fsi-summary">
  <p class="fsi-body mb-2 fs-5">Pieces: {{ metadata.pieces }}</p>
  <div class="quote-total-highlight fsi-summary__total p-3 rounded shadow-sm"> <p class="fsi-section-title fsi-summary__label fw-bold mb-2 fs-4">Quote Total</p> <p class="quote-total-amount fsi-summary__amount display-6 fw-bold text-primary">${{ '%.2f'|format(grand_total) }}</p> </div>
</div>
</div>
<div class="fsi-notice fsi-notice--warning mt-2" role="note">
  <small>
    Disclaimer: All quotes are subject to final evaluation and approval by Freight Services.
    Rates may increase if additional services (e.g., liftgate, residential delivery, or limited access)
    are required but were not included in the initial selection.
  </small>
</div>
<div class="mt-3">
  <p class="fsi-body"><strong>Base Charge:</strong> ${{ '%.2f'|format(base_total) }}</p>

  {% if quote.warnings %}
  <div class="fsi-notice fsi-notice--warning" role="alert">
    <div class="d-flex flex-column flex-lg-row align-items-start gap-3">
      <div class="flex-grow-1 mb-0 fsi-pre-wrap">{{ quote.warnings }}</div>
      {% if exceeds_threshold and can_request_booking_email %}
      <a
        class="btn fsi-button-secondary mt-3 mt-lg-0 text-start"
        href="{{ url_for('quotes.email_volume_request_form', quote_id=quote.quote_id) }}"
      >
        Email for help with volume quote pricing
      </a>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if metadata.miles is not none %}
  <p class="fsi-body">Total Miles: {{ metadata.miles }}</p>
  {% endif %}

  {% if metadata.accessorials %}
  <h2 class="fsi-section-title h3">Accessorials</h2>
  <ul>
  {% for name, cost in metadata.accessorials.items() %}
    <li>{{ name }}: ${{ '%.2f'|format(cost) }}</li>
  {% endfor %}
  </ul>
  <p class="fsi-body"><strong>Accessorials Total:</strong> ${{ '%.2f'|format(metadata.accessorial_total) }}</p>
  {% endif %}

  <!--"##{% if metadata.details %}"
  "#<h3>Details</h3>"
  "#<ul>"
  "#{% for key, value in metadata.details.items() %}"
  "#  <li>{{ key }}: {{ value }}</li>"
  "#{% endfor %}"
  "#</ul>"
  "#{% endif %}"-->

  <div class="fsi-notice fsi-notice--info" role="note">
    Ready to move forward? Click <strong>Book Quote</strong> to complete the shipment yourself through the FreightServices portal, or
    choose <strong>Email to Request Booking</strong> so our team can finalize the load for you for a $15 admin fee.
  </div>
  
  <p class="mb-3">
    <a href="/help/quoting" target="_blank" rel="noopener">Need help?</a>
  </p>
  
  <div class="d-flex flex-wrap gap-2 mb-4">
    <a href="https://freightservices.ts2000.net/Login/" class="btn fsi-button-primary" target="_blank" rel="noopener">Book Quote</a>

    {% if can_request_booking_email %}
    <a href="{{ url_for('quotes.email_request_form', quote_id=quote.quote_id) }}" class="btn fsi-button-secondary">Email to Request Booking ($15 admin fee)</a>
    {% else %}
    <button type="button" class="btn fsi-button-secondary" disabled title="Log in to email a booking request">Email to Request Booking ($15 admin fee)</button>
    {% endif %}
  </div>

  {% if can_request_booking_email %}
  <div class="fsi-card mb-4">
    <div>
      <h2 class="fsi-section-title h5 card-title">Email a Copy to Myself</h2>
      <p class="text-muted mb-3">
        Send a plain-text receipt of this quote to your registered email address ({{ current_user.email }}).
      </p>
      <form method="post" action="{{ url_for('quotes.email_quote_to_me', quote_id=quote.quote_id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button type="submit" class="btn fsi-button-secondary">Send to Myself</button>
      </form>
    </div>
  </div>
  {% endif %}

  {% if can_send_quote_email %}
  <div class="fsi-card mt-4">
    <div>
      <h2 class="fsi-section-title h5">Email this quote summary</h2>
      <p class="mb-3 text-muted">
        Send the key quote details directly to a customer inbox. This form is
        available to Freight Services staff accounts only.
      </p>
      <form method="post" action="{{ url_for('send_email_route') }}" class="row g-3 align-items-end">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="quote_id" value="{{ quote.quote_id }}" />
        <input type="hidden" name="origin_zip" value="{{ quote.origin }}" />
        <input type="hidden" name="destination_zip" value="{{ quote.destination }}" />
        <div class="col-md-6">
          <label class="form-label" for="quote_email_recipient">Recipient email address</label>
          <input
            type="email"
            class="form-control"
            id="quote_email_recipient"
            name="email"
            placeholder="customer@example.com"
            required
          />
        </div>
        <div class="col-md-3 col-lg-2">
          <button type="submit" class="btn fsi-button-primary w-100">Send quote email</button>
        </div>
      </form>
      <p class="small text-muted mt-2 mb-0">
        The automated email includes the origin and destination ZIP codes,
        estimated mileage, and a UTC timestamp.
      </p>
    </div>
  </div>
  {% elif user_can_send_quote_email and not quote_email_smtp_enabled %}
  <div class="fsi-notice fsi-notice--warning mt-4" role="alert">
    SMTP quote emails are currently disabled in the admin dashboard.
  </div>
  {% endif %}
</div>
<a href="{{ url_for('quotes.new_quote') }}" class="btn fsi-button-primary mt-3 fsi-body">Create Another Quote</a>
{% endblock %}
