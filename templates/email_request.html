{% extends 'base.html' %}
{% block content %}
<h2>{{ page_heading }}</h2>
<div class="alert alert-info" role="note">
  <p class="mb-2">
    Need a refresher on this email workflow? Read the
    <a class="alert-link" href="/help/emailing">full instructions</a>.
  </p>
  <p class="mb-2">
    The composed message opens with &ldquo;{{ email_intro_line | safe }}&rdquo; and the subject line
    begins with &ldquo;{{ subject_prefix | safe }}&rdquo;.
  </p>
  {% if admin_fee > 0 %}
  <p class="mb-0">
    The total includes ${{ '%.2f'|format(admin_fee) }} email admin fee when you send this request.
  </p>
  {% else %}
  <p class="mb-0">This request keeps the quoted amount without an added admin fee.</p>
  {% endif %}
</div>
<form id="emailForm">
  <h4 class="d-flex align-items-center gap-2">
    Scheduling
    <span
      class="text-info"
      tabindex="0"
      data-bs-toggle="tooltip"
      data-bs-placement="right"
      title="Select your preferred dates for shipment collection and delivery."
    >
      <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
      <span class="visually-hidden">Help for shipment scheduling section</span>
    </span>
  </h4>
  <div class="row mb-4">
    <div class="col-md-6 mb-2">
      <label for="pickup_date" class="form-label">Desired Pickup Date</label>
      <input id="pickup_date" type="date" name="pickup_date" class="form-control" required>
    </div>
    <div class="col-md-6 mb-2">
      <label for="delivery_date" class="form-label">Desired Delivery Date</label>
      <input id="delivery_date" type="date" name="delivery_date" class="form-control">
    </div>
  </div>

  <h4 class="d-flex align-items-center gap-2">
    Shipper info
    <span
      class="text-info"
      tabindex="0"
      data-bs-toggle="tooltip"
      data-bs-placement="right"
      title="Provide details for the pickup location so the carrier knows where to collect the shipment."
    >
      <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
      <span class="visually-hidden">Help for shipper information section</span>
    </span>
  </h4>
  <div class="mb-2">
    <label>Name <input type="text" name="shipper_name" class="form-control"></label>
  </div>
  <div class="mb-2">
    <label>
      Street Address
      <input id="shipper_street" type="text" name="shipper_street" class="form-control">
    </label>
    <div id="shipper_address_feedback" class="form-text text-warning d-none" aria-live="polite"></div>
  </div>
  <div class="mb-2">
    <label>City <input id="shipper_city" type="text" name="shipper_city" class="form-control"></label>
  </div>
  <div class="mb-2">
    <label>State <input id="shipper_state" type="text" name="shipper_state" class="form-control"></label>
  </div>
  <div class="mb-2">
    <label>
      Zip
      <span
        class="ms-1 text-info"
        tabindex="0"
        data-bs-toggle="tooltip"
        data-bs-placement="right"
        title="Enter the five-digit ZIP code for the pickup location."
      >
        <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
        <span class="visually-hidden">Help for shipper ZIP</span>
      </span>
      <input id="shipper_zip" type="text" name="shipper_zip" class="form-control" value="{{ quote.origin }}">
    </label>
  </div>
  <div class="mb-2">
    <label>
      Contact
      <span
        class="ms-1 text-info"
        tabindex="0"
        data-bs-toggle="tooltip"
        data-bs-placement="right"
        title="Identify the on-site contact for pickup updates and driver check-in."
      >
        <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
        <span class="visually-hidden">Help for shipper contact</span>
      </span>
      <input type="text" name="shipper_contact" class="form-control">
    </label>
  </div>
  <div class="mb-2">
    <label>Shipper Reference <input type="text" name="shipper_reference" class="form-control"></label>
  </div>
  <div class="mb-2">
    <label>Phone <input type="text" name="shipper_phone" class="form-control"></label>
  </div>
  <div class="mb-3">
    <label for="shipper_notes" class="form-label">Shipper Notes / Pickup Instructions</label>
    <textarea
      id="shipper_notes"
      name="shipper_notes"
      class="form-control"
      rows="5"
      maxlength="2000"
      placeholder="Add pickup notes, dock details, hours, access instructions, or other shipper guidance."
    ></textarea>
  </div>
  <h4 class="d-flex align-items-center gap-2">
    Consignee info
    <span
      class="text-info"
      tabindex="0"
      data-bs-toggle="tooltip"
      data-bs-placement="right"
      title="Provide delivery location details so the carrier can complete the drop-off without delay."
    >
      <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
      <span class="visually-hidden">Help for consignee information section</span>
    </span>
  </h4>
  <div class="mb-2">
    <label>Name <input type="text" name="consignee_name" class="form-control"></label>
  </div>
  <div class="mb-2">
    <label>
      Street Address
      <input id="consignee_street" type="text" name="consignee_street" class="form-control">
    </label>
    <div id="consignee_address_feedback" class="form-text text-warning d-none" aria-live="polite"></div>
  </div>
  <div class="mb-2">
    <label>City <input id="consignee_city" type="text" name="consignee_city" class="form-control"></label>
  </div>
  <div class="mb-2">
    <label>State <input id="consignee_state" type="text" name="consignee_state" class="form-control"></label>
  </div>
  <div class="mb-2">
    <label>
      Zip
      <span
        class="ms-1 text-info"
        tabindex="0"
        data-bs-toggle="tooltip"
        data-bs-placement="right"
        title="Enter the five-digit ZIP code for the delivery location."
      >
        <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
        <span class="visually-hidden">Help for consignee ZIP</span>
      </span>
      <input id="consignee_zip" type="text" name="consignee_zip" class="form-control" value="{{ quote.destination }}">
    </label>
  </div>
  <div class="mb-2">
    <label>
      Contact
      <span
        class="ms-1 text-info"
        tabindex="0"
        data-bs-toggle="tooltip"
        data-bs-placement="right"
        title="Identify the primary receiver or dock contact for delivery updates."
      >
        <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
        <span class="visually-hidden">Help for consignee contact</span>
      </span>
      <input type="text" name="consignee_contact" class="form-control">
    </label>
  </div>
  <div class="mb-2">
    <label>Consignee Reference <input type="text" name="consignee_reference" class="form-control"></label>
  </div>
  <div class="mb-2">
    <label>Phone <input type="text" name="consignee_phone" class="form-control"></label>
  </div>
  <div class="mb-3">
    <label for="consignee_notes" class="form-label">Consignee Notes / Delivery Instructions</label>
    <textarea
      id="consignee_notes"
      name="consignee_notes"
      class="form-control"
      rows="5"
      maxlength="2000"
      placeholder="Add delivery notes, receiving requirements, site restrictions, or other consignee guidance."
    ></textarea>
  </div>

  <div class="fsi-email-request__return-panel">
    <div class="form-check mb-3">
      <input
        class="form-check-input"
        type="checkbox"
        id="return_quote_requested"
        name="return_quote_requested"
      >
      <label class="form-check-label fw-bold" for="return_quote_requested">
        Will you need a return shipment?/Return handling Requested (FSI will reply with a return quote)
      </label>
    </div>

    <div id="return_shipment_details" class="d-none">
      <div class="mb-3">
        <label for="return_pickup_date" class="form-label">Desired return pickup date</label>
        <input type="date" id="return_pickup_date" name="return_pickup_date" class="form-control">
      </div>
      <div class="mb-3">
        <p class="form-label mb-2">Return accessorial (select any that apply)</p>
        <div id="return_accessorial" class="border rounded p-2">
          {% for option in return_accessorial_options %}
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              value="{{ option }}"
              id="return_accessorial_{{ loop.index }}"
              name="return_accessorial"
            >
            <label class="form-check-label" for="return_accessorial_{{ loop.index }}">
              {{ option }}
            </label>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="mb-0">
        <label for="return_notes" class="form-label">Return-specific notes</label>
        <textarea
          id="return_notes"
          name="return_notes"
          class="form-control"
          rows="4"
          maxlength="2000"
          placeholder="Add return pickup notes, access instructions, or special handling details."
        ></textarea>
      </div>
    </div>
  </div>

  <button type="submit" class="btn btn-primary mt-3">Compose Email</button>
</form>
{% set base_total = quote.total - metadata.accessorial_total %}
{% if maps_api_key %}
<script
  src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key|urlencode }}&libraries=places&callback=initAddressAutocomplete"
  async
  defer
></script>
{% endif %}
<script>
const data = {{ {
  "origin": quote.origin,
  "destination": quote.destination,
  "weight": quote.weight,
  "pieces": quote.pieces,
  "weight_type": quote.weight_method,
  "accessorials": metadata.accessorials,
  "accessorial_total": metadata.accessorial_total,
  "accessorial_names": accessorial_names,
  "quote_id": quote.quote_id,
  "user_name": user_name,
  "user_company": user_company,
  "total_with_fee": total_with_fee,
  "base_total": base_total,
  "email_intro_line": email_intro_line,
  "subject_prefix": subject_prefix,
  "admin_fee": admin_fee
}|tojson }};

function updateAddressFeedback(feedbackElement, message) {
  if (!feedbackElement) return;
  feedbackElement.textContent = message;
  feedbackElement.classList.toggle('d-none', !message);
}

function getAddressParts(place) {
  const parts = { city: '', state: '', zip: '' };
  if (!place || !Array.isArray(place.address_components)) return parts;

  for (const component of place.address_components) {
    const types = component.types || [];
    if (!parts.city && (types.includes('locality') || types.includes('postal_town'))) {
      parts.city = component.long_name || '';
    }
    if (!parts.state && types.includes('administrative_area_level_1')) {
      parts.state = component.short_name || component.long_name || '';
    }
    if (!parts.zip && types.includes('postal_code')) {
      parts.zip = component.long_name || '';
    }
  }
  return parts;
}

function bindAddressAutocomplete(prefix) {
  const streetField = document.getElementById(`${prefix}_street`);
  const cityField = document.getElementById(`${prefix}_city`);
  const stateField = document.getElementById(`${prefix}_state`);
  const zipField = document.getElementById(`${prefix}_zip`);
  const feedbackElement = document.getElementById(`${prefix}_address_feedback`);

  if (!streetField || !window.google || !google.maps || !google.maps.places) return;

  const autocomplete = new google.maps.places.Autocomplete(streetField, {
    types: ['address'],
    componentRestrictions: { country: 'us' }
  });

  autocomplete.addListener('place_changed', () => {
    const place = autocomplete.getPlace();
    const parts = getAddressParts(place);
    const hasKnownLocation = Boolean(place && Array.isArray(place.address_components) && place.address_components.length);

    if (parts.city && cityField) cityField.value = parts.city;
    if (parts.state && stateField) stateField.value = parts.state;
    if (parts.zip && zipField) zipField.value = parts.zip;

    if (!hasKnownLocation) {
      updateAddressFeedback(feedbackElement, 'Address details could not be verified. Please review manually.');
      return;
    }
    if (!parts.city || !parts.state || !parts.zip) {
      updateAddressFeedback(feedbackElement, 'Some address details were unavailable. Please confirm city, state, and ZIP.');
      return;
    }
    updateAddressFeedback(feedbackElement, '');
  });
}

function initAddressAutocomplete() {
  bindAddressAutocomplete('shipper');
  bindAddressAutocomplete('consignee');
}

if (window.google && google.maps && google.maps.places) {
  initAddressAutocomplete();
}

const returnQuoteCheckbox = document.getElementById('return_quote_requested');
const returnShipmentDetails = document.getElementById('return_shipment_details');

function toggleReturnShipmentDetails() {
  if (!returnQuoteCheckbox || !returnShipmentDetails) return;
  returnShipmentDetails.classList.toggle('d-none', !returnQuoteCheckbox.checked);
}

if (returnQuoteCheckbox && returnShipmentDetails) {
  returnQuoteCheckbox.addEventListener('change', toggleReturnShipmentDetails);
  toggleReturnShipmentDetails();
}

function normalizeFreeformNotes(value) {
  return (value || '')
    .replace(/\r\n?/g, '\n')
    .split('\n')
    .map((line) => line.replace(/\s+$/g, ''))
    .join('\n')
    .trimEnd();
}

document.getElementById('emailForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const f = e.target;
  const pickupDate = f.pickup_date.value;
  const deliveryDate = f.delivery_date.value || 'Not specified';
  const returnQuoteRequested = f.return_quote_requested.checked;
  const shipper = {
    name: f.shipper_name.value,
    street: f.shipper_street.value,
    city: f.shipper_city.value,
    state: f.shipper_state.value,
    zip: f.shipper_zip.value,
    contact: f.shipper_contact.value,
    reference: f.shipper_reference.value,
    phone: f.shipper_phone.value,
    notes: normalizeFreeformNotes(f.shipper_notes.value)
  };
  const returnDetails = {
    pickupDate: f.return_pickup_date.value,
    accessorials: Array.from(
      f.querySelectorAll('input[name="return_accessorial"]:checked'),
      (checkbox) => checkbox.value
    ),
    notes: normalizeFreeformNotes(f.return_notes.value)
  };
  const consignee = {
    name: f.consignee_name.value,
    street: f.consignee_street.value,
    city: f.consignee_city.value,
    state: f.consignee_state.value,
    zip: f.consignee_zip.value,
    contact: f.consignee_contact.value,
    reference: f.consignee_reference.value,
    phone: f.consignee_phone.value,
    notes: normalizeFreeformNotes(f.consignee_notes.value)
  };

  // --- BUILD EMAIL BODY WITH PROFESSIONAL FORMATTING ---
  const pad = (str, len) => (str || '').padEnd(len);
  
  let body = `${data.email_intro_line}\n\n`;

  // 1. Quote Header
  body += `QUOTE DETAILS\n`;
  body += `==========================================\n`;
  body += `Quote ID:      ${data.quote_id}\n`;
  body += `Pickup Date:   ${pickupDate}\n`;
  body += `Delivery Date: ${deliveryDate}\n`;
  body += `Return Quote:  ${returnQuoteRequested ? 'YES' : 'No'}\n\n`;

  // 2. Route & Shipment Specs
  body += `SHIPMENT SPECIFICATIONS\n`;
  body += `------------------------------------------\n`;
  body += `Origin:        ${data.origin}\n`;
  body += `Destination:   ${data.destination}\n`;
  body += `Pieces:        ${data.pieces}\n`;
  body += `Weight:        ${data.weight} lbs (${data.weight_type})\n`;
  body += `Accessorials:  ${data.accessorial_names || 'None'}\n\n`;

  // 3. Financials (Aligned)
  body += `PRICING BREAKDOWN\n`;
  body += `------------------------------------------\n`;
  body += `Base Charge:            $${data.base_total.toFixed(2).padStart(8)}\n`;
  
  for (const [name, cost] of Object.entries(data.accessorials || {})) {
    // Truncate name to 22 chars to keep alignment, pad right
    body += `${name.substring(0, 22).padEnd(23)} $${cost.toFixed(2).padStart(8)}\n`;
  }
  
  body += `------------------------------------------\n`;
  
  const adminFee = Number(data.admin_fee || 0);
  const totalWithFee = Number(data.base_total || 0) + Number(data.accessorial_total || 0) + adminFee;
  const adminFeeNote = adminFee > 0 ? ` (includes $${adminFee.toFixed(2)} admin fee)` : "";
  
  body += `TOTAL:                  $${totalWithFee.toFixed(2).padStart(8)}${adminFeeNote}\n`;
  body += `==========================================\n\n`;

  // 4. Shipper / Consignee Blocks
  body += `SHIPMENT DETAILS\n`;
  body += `==========================================\n\n`;

  body += `[ SHIPPER ]\n`;
  body += `Name:    ${shipper.name}\n`;
  body += `Address: ${shipper.street}\n`;
  body += `         ${shipper.city}, ${shipper.state} ${shipper.zip}\n`;
  body += `Shipper Reference: ${shipper.reference}\n`;
  body += `Contact: ${shipper.contact}\n`;
  body += `Phone:   ${shipper.phone}\n`;
  if (shipper.notes) {
    body += `NOTES:\n${shipper.notes}\n`;
  }
  body += `\n`;

  body += `[ CONSIGNEE ]\n`;
  body += `Name:    ${consignee.name}\n`;
  body += `Address: ${consignee.street}\n`;
  body += `         ${consignee.city}, ${consignee.state} ${consignee.zip}\n`;
  body += `Consignee Reference: ${consignee.reference}\n`;
  body += `Contact: ${consignee.contact}\n`;
  body += `Phone:   ${consignee.phone}\n`;
  if (consignee.notes) {
    body += `NOTES:\n${consignee.notes}\n`;
  }
  body += `\n`;

  if (returnQuoteRequested) {
    body += `[ RETURN SHIPMENT REQUEST ]\n`;
    body += `Desired Pickup Date: ${returnDetails.pickupDate || 'Not provided'}\n`;
    body += `Return Accessorial:  ${returnDetails.accessorials.join(', ') || 'Not selected'}\n`;
    if (returnDetails.notes) {
      body += `NOTES:\n${returnDetails.notes}\n`;
    }
    body += `\n`;
  }

  // Final Link Generation
  const subject = `${data.subject_prefix}: ${data.origin} to ${data.destination} - Quote ${data.quote_id}`;
  const mailto = `mailto:operations@freightservices.net?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailto;
});
</script>
{% endblock %}
