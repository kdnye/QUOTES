<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>{% block title %}FSI Quote Tool{% endblock %}</title>
    {{ fsi_theme()|safe }}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    {% block head %}{% endblock %}
  </head>
  <body>
   <nav class="navbar navbar-expand-lg fsi-navbar">
  <div class="container-fluid fsi-navbar__container">
    <a class="navbar-brand fsi-brand" href="/" aria-label="Freight Services Quote Tool Home">
      <span class="fsi-brand__lockup" aria-hidden="true">FSI</span>
      <span class="fsi-brand__text">
        <span class="fsi-brand__site">Freight Services Inc.</span>
        <span class="fsi-brand__app">Quote Tool</span>
      </span>
    </a>

    <button
      class="navbar-toggler fsi-navbar__toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#mainNav"
      aria-controls="mainNav"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse fsi-navbar__collapse" id="mainNav">
      <ul class="navbar-nav ms-auto fsi-navbar__menu d-flex align-items-lg-center gap-3">
        
        <li class="nav-item">
          <a class="fsi-brand__lockup d-flex align-items-center justify-content-center text-decoration-none" 
             aria-hidden="true" 
             href="/quotes/new">Get New Quote</a>
        </li>
        <li class="nav-item">
          <a class="fsi-brand__lockup d-flex align-items-center justify-content-center text-decoration-none" 
             aria-hidden="true" 
             href="{{ url_for('quotes.lookup_quote') }}">Quote Lookup</a>
        </li>

        <li class="nav-item">
          <a
            class="nav-link fsi-nav-link fsi-nav-link--icon d-flex align-items-center justify-content-center"
            href="{{ url_for('help.help_index') }}"
            aria-label="Help"
            title="Help"
          >
            <span aria-hidden="true" class="fw-semibold">?</span>
          </a>
        </li>

        {% if current_user.is_authenticated %}
          {% if current_user.role == 'super_admin' or current_user.is_admin %}
            <li class="nav-item">
              <a class="nav-link fsi-nav-link" href="{{ url_for('admin.dashboard') }}">Admin Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link fsi-nav-link" href="{{ url_for('admin_quotes.quotes_html') }}">All Quotes</a>
            </li>
          {% elif current_user.role == 'employee' and current_user.employee_approved %}
            <li class="nav-item">
              <a class="nav-link fsi-nav-link" href="{{ url_for('admin.dashboard') }}">Team Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link fsi-nav-link" href="{{ url_for('admin_quotes.quotes_html') }}">Quotes</a>
            </li>
          {% endif %}

          <li class="nav-item dropdown">
            <a
              class="nav-link fsi-nav-link dropdown-toggle d-flex align-items-center gap-2"
              href="#"
              id="accountMenu"
              role="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <i class="bi bi-person-circle" aria-hidden="true"></i>
              <span class="fw-semibold">{{ current_user.first_name or current_user.email }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="accountMenu">
              <li class="dropdown-header small text-muted">
                Signed in as<br />
                <strong>{{ current_user.name or current_user.email }}</strong>
              </li>
              <li><a class="dropdown-item" href="{{ url_for('auth.settings') }}">Account settings</a></li>
              <li><a class="dropdown-item" href="{{ url_for('auth.reset_request') }}">Password reset</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Sign out</a></li>
            </ul>
          </li>
        {% endif %}

        <li class="nav-item">
          <div class="form-check form-switch ms-3">
            <input class="form-check-input" type="checkbox" id="topbarDarkModeToggle" />
            <label class="form-check-label" for="topbarDarkModeToggle">Dark Mode</label>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>

    <main class="{% block main_class %}container{% endblock %} py-4">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mt-2">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const overrideSwitch = document.getElementById("overrideSystem");
        const settingsDarkSwitch = document.getElementById("darkModeToggle");
        const topbarDarkSwitch = document.getElementById("topbarDarkModeToggle");
        const manualContainer = document.getElementById("manualToggleContainer");
        const systemThemeQuery = window.matchMedia("(prefers-color-scheme: dark)");
        const csrfToken =
          document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") ||
          "";
        let activePreference =
          '{{ current_user.theme_preference if current_user.is_authenticated else "auto" }}';

        const applyTheme = (theme) => {
          let targetTheme = theme;
          if (theme === "auto") {
            targetTheme = systemThemeQuery.matches ? "dark" : "light";
          }
          document.documentElement.setAttribute("data-bs-theme", targetTheme);

          if (settingsDarkSwitch) {
            settingsDarkSwitch.checked = targetTheme === "dark";
          }
          if (topbarDarkSwitch) {
            topbarDarkSwitch.checked = targetTheme === "dark";
          }
        };

        const updateUserTheme = async (preference) => {
          activePreference = preference;
          applyTheme(preference);

          if (!{{ "true" if current_user.is_authenticated else "false" }}) {
            return;
          }

          const headers = { "Content-Type": "application/json" };
          if (csrfToken) {
            headers["X-CSRFToken"] = csrfToken;
          }

          try {
            const response = await fetch("/settings/theme", {
              method: "POST",
              headers,
              body: JSON.stringify({ theme: preference }),
            });
            if (!response.ok) {
              throw new Error(`Theme update failed with status ${response.status}`);
            }
          } catch (error) {
            console.error(error);
          }
        };

        if (overrideSwitch && settingsDarkSwitch && manualContainer) {
          overrideSwitch.addEventListener("change", () => {
            if (overrideSwitch.checked) {
              manualContainer.style.display = "block";
              updateUserTheme(settingsDarkSwitch.checked ? "dark" : "light");
              return;
            }
            manualContainer.style.display = "none";
            updateUserTheme("auto");
          });

          settingsDarkSwitch.addEventListener("change", () => {
            if (overrideSwitch.checked) {
              updateUserTheme(settingsDarkSwitch.checked ? "dark" : "light");
            }
          });
        }

        if (topbarDarkSwitch) {
          topbarDarkSwitch.addEventListener("change", () => {
            const selected = topbarDarkSwitch.checked ? "dark" : "light";
            if (overrideSwitch && manualContainer) {
              overrideSwitch.checked = true;
              manualContainer.style.display = "block";
              if (settingsDarkSwitch) {
                settingsDarkSwitch.checked = topbarDarkSwitch.checked;
              }
            }
            updateUserTheme(selected);
          });
        }

        systemThemeQuery.addEventListener("change", () => {
          if (activePreference === "auto") {
            applyTheme("auto");
          }
        });

        applyTheme(activePreference);

        const tips = [...document.querySelectorAll('[data-bs-toggle="tooltip"]')];
        tips.map((t) => new bootstrap.Tooltip(t));
      });
    </script>
  </body>
</html>
